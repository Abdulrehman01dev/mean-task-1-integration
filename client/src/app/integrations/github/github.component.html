<section style="padding:16px">
  <h1>GitHub Integration</h1>

  <mat-card appearance="outlined" style="margin-top:12px">
    <div class="status-row">
      <span class="status-indicator" [class.connected]="isConnected" [class.disconnected]="!isConnected"></span>
      <div class="status-text">
        <div class="status-title" *ngIf="isConnected; else notConnected">Connected</div>
        <ng-template #notConnected>
          <div class="status-title">Not connected</div>
        </ng-template>
        <div class="status-sub" *ngIf="isConnected && connectedUser?.connectedAt">Since {{ connectedUser?.connectedAt | date:'medium' }}</div>
      </div>

      <span class="spacer"></span>

      <button *ngIf="!isConnected" mat-flat-button color="primary" (click)="connect()"
              matTooltip="Redirect to GitHub OAuth ">
        Connect
      </button>
    </div>
  </mat-card>

  <mat-expansion-panel style="margin-top:12px">
    <mat-expansion-panel-header>
      <mat-panel-title> Integration actions </mat-panel-title>
      <mat-panel-description>
        Manage your GitHub connection
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div class="panel-content">
      <div class="user-block" *ngIf="isConnected; else connectHint">
        <div class="user-title">Authenticated user</div>
        <div class="user-line">Login Name: {{ connectedUser?.login || '—' }}</div>
        <div class="user-line">Account Url: {{ connectedUser?.url || '—' }}</div>
      </div>
      <ng-template #connectHint>
        <div class="muted">Connect to view authenticated user details.</div>
      </ng-template>

      <mat-divider style="margin:12px 0"></mat-divider>

      <div class="actions">
        <button mat-stroked-button color="warn" (click)="removeIntegration()" [disabled]="!isConnected">
          Remove Integration
        </button>

        <button mat-stroked-button color="primary" (click)="resync()" [disabled]="!isConnected">
          Re-sync Integration
        </button>
      </div>

    </div>
  </mat-expansion-panel>

  <mat-card appearance="outlined" style="margin-top:16px">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <strong>Raw Data</strong>
      <span class="spacer"></span>
      <mat-form-field appearance="outline" style="width:260px">
        <mat-label>Search</mat-label>
        <input matInput #q (keyup)="applyFilter(q.value)" placeholder="Search message, author, branch..." />
      </mat-form-field>
    </div>

    <div style="overflow:auto;margin-top:8px">
      <table mat-table [dataSource]="dataSource" matSort style="min-width:1200px">
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row"><mat-checkbox></mat-checkbox></td>
        </ng-container>

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> id </th>
          <td mat-cell *matCellDef="let row"> {{ row.id }} </td>
        </ng-container>

        <ng-container matColumnDef="hash">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Hash </th>
          <td mat-cell *matCellDef="let row"> {{ row.hash }} </td>
        </ng-container>

        <ng-container matColumnDef="branch">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Branch </th>
          <td mat-cell *matCellDef="let row"> {{ row.branch }} </td>
        </ng-container>

        <ng-container matColumnDef="message">
          <th mat-header-cell *matHeaderCellDef> Message </th>
          <td mat-cell *matCellDef="let row">
            <div style="max-width:380px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ row.message }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Date </th>
          <td mat-cell *matCellDef="let row"> {{ row.date | date:'medium' }} </td>
        </ng-container>

        <ng-container matColumnDef="repoName">
          <th mat-header-cell *matHeaderCellDef> Repository Name </th>
          <td mat-cell *matCellDef="let row"> {{ row.repoName }} </td>
        </ng-container>

        <ng-container matColumnDef="repoUid">
          <th mat-header-cell *matHeaderCellDef> Repository Uid </th>
          <td mat-cell *matCellDef="let row"> {{ row.repoUid }} </td>
        </ng-container>

        <ng-container matColumnDef="authorUid">
          <th mat-header-cell *matHeaderCellDef> Author Uid </th>
          <td mat-cell *matCellDef="let row"> {{ row.authorUid }} </td>
        </ng-container>

        <ng-container matColumnDef="authorName">
          <th mat-header-cell *matHeaderCellDef> Author Name </th>
          <td mat-cell *matCellDef="let row"> {{ row.authorName }} </td>
        </ng-container>

        <ng-container matColumnDef="pullrequest">
          <th mat-header-cell *matHeaderCellDef> Pullrequest </th>
          <td mat-cell *matCellDef="let row"> {{ row.pullrequest || '—' }} </td>
        </ng-container>

        <ng-container matColumnDef="url">
          <th mat-header-cell *matHeaderCellDef> Url </th>
          <td mat-cell *matCellDef="let row">
            <a href="{{ row.url }}" target="_blank" rel="noreferrer">link</a>
          </td>
        </ng-container>

        <ng-container matColumnDef="checksum">
          <th mat-header-cell *matHeaderCellDef> Checksum </th>
          <td mat-cell *matCellDef="let row"> {{ row.checksum }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
    <mat-paginator [pageSize]="10" [pageSizeOptions]="[10,25,50,100]"></mat-paginator>
  </mat-card>
</section>