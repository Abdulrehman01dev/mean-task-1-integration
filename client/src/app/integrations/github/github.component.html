<section style="padding:16px">
  <h1>GitHub Integration</h1>

  <mat-card appearance="outlined" style="margin-top:12px">
    <div class="status-row">
      <span class="status-indicator" [class.connected]="isConnected" [class.disconnected]="!isConnected"></span>
      <div class="status-text">
        <div class="status-title" *ngIf="isConnected; else notConnected">Connected</div>
        <ng-template #notConnected>
          <div class="status-title">Not connected</div>
        </ng-template>
        <div class="status-sub" *ngIf="isConnected && connectedUser?.connectedAt">Since {{ connectedUser?.connectedAt | date:'medium' }}</div>
      </div>

      <span class="spacer"></span>

      <button *ngIf="!isConnected" mat-flat-button color="primary" (click)="onConnect()"
              matTooltip="Redirect to GitHub OAuth ">
        Connect
      </button>
    </div>
  </mat-card>

  <mat-expansion-panel style="margin-top:12px">
    <mat-expansion-panel-header>
      <mat-panel-title> Integration actions </mat-panel-title>
      <mat-panel-description>
        Manage your GitHub connection
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div class="panel-content">
      <div class="user-block" *ngIf="isConnected; else connectHint">
        <div class="user-title">Authenticated user</div>
        <div class="user-line">Login Name: {{ connectedUser.login || 'N/A' }}</div>
        <div class="user-line">Account API Url: {{ connectedUser.url || 'N/A' }}</div>
      </div>
      <ng-template #connectHint>
        <div class="muted">Connect to view authenticated user details.</div>
      </ng-template>

      <mat-divider style="margin:12px 0"></mat-divider>

      <div class="actions">
        <button mat-stroked-button color="warn" (click)="onRemoveIntegration()" [disabled]="!isConnected">
          Remove Integration
        </button>

        <button mat-stroked-button color="primary" (click)="onResync()" [disabled]="!isConnected">
          Re-sync Integration
        </button>
      </div>

    </div>
  </mat-expansion-panel>

  <mat-card appearance="outlined" style="margin-top:16px">



    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap; padding:20px">
      <strong>Raw Data</strong>
      <span class="spacer"></span>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:0px">
        <mat-form-field appearance="outline" style="width:260px">
          <mat-label>Active Integration</mat-label>
          <mat-select [(value)]="selectedActiveIntegration" (selectionChange)="onActiveIntegrationChange()">
            <mat-option *ngFor="let a of activeIntegrations" [value]="a.value">{{ a.name }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" style="width:260px">
          <mat-label>Entity</mat-label>
          <mat-select [(value)]="selectedEntity" (selectionChange)="onEntityChange()">
            <mat-option *ngFor="let e of entries" [value]="e.value">{{ e.name }}</mat-option>
          </mat-select>
        </mat-form-field>
      
        <mat-form-field appearance="outline" style="width:260px">
          <mat-label>Search</mat-label>
          <input matInput #q (keyup)="onApplyFilter(q.value)" placeholder="Search..." />
        </mat-form-field>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section" style="padding:0 20px 20px 20px;border-top:1px solid #e0e0e0;margin-top:8px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-top:16px">
        <div style="display:flex;align-items:center;gap:8px">
          <strong>Filters</strong>
          <span *ngIf="getFilteredCount() > 0" style="color:#616161;font-size:12px">
            ({{ getFilteredCount() }} active)
          </span>
        </div>
        <div style="display:flex;gap:8px">
          <button mat-stroked-button (click)="onAddFilterRow()" style="height:36px">
            <mat-icon style="font-size:18px;width:18px;height:18px;margin-right:4px">add</mat-icon>
            Add Filter
          </button>
          <button mat-stroked-button (click)="onApplyFilters()" [disabled]="getFilteredCount() === 0" color="primary" style="height:36px">
            Apply Filters
          </button>
          <button mat-stroked-button (click)="onClearFilters()" [disabled]="filterRows.length === 0 && getFilteredCount() === 0" color="warn" style="height:36px">
            Clear All
          </button>
        </div>
      </div>

      <div *ngIf="filterRows.length > 0" class="filter-rows">
        <div *ngFor="let filter of filterRows; let i = index" class="filter-row" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <mat-form-field appearance="outline" style="width:200px;flex-shrink:0">
            <mat-label>Field</mat-label>
            <mat-select [(value)]="filter.field">
              <mat-option *ngFor="let field of availableFields" [value]="field">{{ field | titlecase }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" style="flex:1">
            <mat-label>Value</mat-label>
            <input matInput [(ngModel)]="filter.value" placeholder="Enter filter value..." />
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="onRemoveFilterRow(i)" matTooltip="Remove filter">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      <div *ngIf="filterRows.length === 0" class="no-filters" style="color:#757575;font-size:14px;padding:8px 0">
        No filters added. Click "Add Filter" to add a filter.
      </div>
    </div>

    <div class="table-wrapper" style="overflow:auto;margin-top:8px; position: relative;">
      <table mat-table [dataSource]="dataSource" matSort  matSort (matSortChange)="onSort($event)" style="min-width:1200px">
        <ng-container *ngFor="let column of displayedColumns" [matColumnDef]="column">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ column | titlecase }} </th>
          <td mat-cell *matCellDef="let element">
            <span class="clamp-2lines">{{ element[column] || "N/A" }}</span>
            
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <div class="table-loader" *ngIf="isLoading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    </div>
    <mat-paginator [pageSize]="pageSize" [pageSizeOptions]="[10,25,50,100]" [length]="totalCount" (page)="onPageChange($event)" [disabled]="isLoading"></mat-paginator>
  </mat-card>
</section>